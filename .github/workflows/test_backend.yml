name: Backend Tests

on:
    push:
        branches:
            - main
            - develop
        paths:
            - "Backend/**"
            - ".github/workflows/test_backend.yml"
    pull_request:
        branches:
            - main
            - develop
        paths:
            - "Backend/**"
    workflow_dispatch:
    workflow_call:

jobs:
    test:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: ["3.13"]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}

            - name: Install uv
              run: |
                  curl -LsSf https://astral.sh/uv/install.sh | sh
                  echo "$HOME/.cargo/bin" >> $GITHUB_PATH

            - name: Install dependencies
              working-directory: Backend
              run: |
                  uv venv
                  source .venv/bin/activate
                  uv pip install -e .

            - name: Set up environment variables
              working-directory: Backend
              run: |
                  cat > .env << EOF
                  DJANGO_ENV=test
                  DJANGO_SETTINGS_MODULE=config.settings.test
                  SECRET_KEY=test-secret-key-for-ci-testing-only
                  DEBUG=False
                  ALLOWED_HOSTS=localhost,127.0.0.1
                  EOF

            - name: Run linting (Ruff)
              working-directory: Backend
              run: |
                  source .venv/bin/activate
                  ruff check .

            - name: Run type checking (mypy)
              working-directory: Backend
              run: |
                  source .venv/bin/activate
                  mypy . || true

            - name: Run formatting check (Black)
              working-directory: Backend
              run: |
                  source .venv/bin/activate
                  black --check .

            - name: Run migrations
              working-directory: Backend
              run: |
                  source .venv/bin/activate
                  python manage.py migrate --noinput

            - name: Run tests
              working-directory: Backend
              run: |
                  source .venv/bin/activate
                  pytest -n auto

            - name: Test summary
              run: |
                  echo "âœ… All backend tests passed!"
                  echo "ðŸ Python version: ${{ matrix.python-version }}"
                  echo "ðŸ—„ï¸ Database: SQLite (in-memory)"
                  echo "âš¡ Parallel execution: enabled"
