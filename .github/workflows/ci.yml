name: CI - All Tests

on:
    push:
        branches:
            - main
            - develop
    pull_request:
        branches:
            - main
            - develop
    workflow_dispatch:

jobs:
    backend-tests:
        name: Backend Tests
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:16
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: test_db
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python 3.13
              uses: actions/setup-python@v5
              with:
                  python-version: "3.13"
                  cache: "pip"
                  cache-dependency-path: "Backend/pyproject.toml"

            - name: Install uv
              run: |
                  curl -LsSf https://astral.sh/uv/install.sh | sh
                  echo "$HOME/.cargo/bin" >> $GITHUB_PATH

            - name: Install dependencies
              working-directory: Backend
              run: |
                  uv venv
                  source .venv/bin/activate
                  uv pip install -e .

            - name: Set up environment
              working-directory: Backend
              run: |
                  cat > .env << EOF
                  DJANGO_ENV=test
                  DJANGO_SETTINGS_MODULE=config.settings.test
                  SECRET_KEY=test-secret-key-for-ci
                  DEBUG=False
                  DATABASE_URL=postgresql://postgres:postgres@localhost:5432/test_db
                  EOF

            - name: Lint with Ruff
              working-directory: Backend
              run: |
                  source .venv/bin/activate
                  ruff check .

            - name: Format check with Black
              working-directory: Backend
              run: |
                  source .venv/bin/activate
                  black --check .

            - name: Run migrations
              working-directory: Backend
              env:
                  DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
              run: |
                  source .venv/bin/activate
                  python manage.py migrate --noinput

            - name: Run tests
              working-directory: Backend
              env:
                  DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
              run: |
                  source .venv/bin/activate
                  pytest --cov=. --cov-report=xml

    frontend-tests:
        name: Frontend Tests
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: "Frontend/package-lock.json"

            - name: Install dependencies
              working-directory: Frontend
              run: npm ci

            - name: Type check
              working-directory: Frontend
              run: npm run type-check

            - name: Lint
              working-directory: Frontend
              run: npm run lint

            - name: Run tests
              working-directory: Frontend
              run: npm run test:coverage

            - name: Build
              working-directory: Frontend
              run: npm run build

    status-check:
        name: All Tests Passed
        needs: [backend-tests, frontend-tests]
        runs-on: ubuntu-latest
        steps:
            - name: Success
              run: |
                  echo "âœ… All tests passed successfully!"
                  echo "ðŸŽ‰ Backend and Frontend are ready!"
